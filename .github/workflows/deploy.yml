name: EyeDock Deploy Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Pular testes'
        required: false
        default: false
        type: boolean

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx4096m -Dorg.gradle.parallel=true
  ANDROID_SDK_ROOT: ${{ secrets.ANDROID_SDK_ROOT }}

jobs:
  # Job 1: Testes Automatizados
  automated-tests:
    name: ðŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests || github.event_name != 'workflow_dispatch' }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ” Run Lint & Static Analysis
      run: |
        echo "ðŸ” Executando anÃ¡lise estÃ¡tica..."
        ./gradlew lint
        ./gradlew detekt
        ./gradlew ktlintCheck
        
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "ðŸ§ª Executando testes unitÃ¡rios..."
        ./gradlew :app:testDebugUnitTest --info --rerun-tasks
        
    - name: ðŸ“Š Generate Test Coverage
      run: |
        echo "ðŸ“Š Gerando relatÃ³rio de cobertura..."
        ./gradlew jacocoTestReport
        
    - name: âœ… Test Quality Gate
      run: |
        echo "âœ… Verificando qualidade dos testes..."
        # Verificar se todos os testes passaram
        if [ -f "app/build/reports/tests/testDebugUnitTest/index.html" ]; then
          echo "âœ… Testes executados com sucesso!"
        else
          echo "âŒ Falha nos testes!"
          exit 1
        fi
        
    - name: ðŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_id }}
        path: |
          app/build/reports/tests/
          app/build/reports/jacoco/
          app/build/test-results/
        retention-days: 30
        
    - name: ðŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./app/build/reports/jacoco/test/jacocoTestReport.xml
        flags: unittests
        name: codecov-umbrella

  # Job 2: Build da AplicaÃ§Ã£o
  build-app:
    name: ðŸ”¨ Build da AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: automated-tests
    if: success()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ”¨ Build Debug APK
      run: |
        echo "ðŸ”¨ Construindo APK de debug..."
        ./gradlew assembleDebug
        
    - name: ðŸ”¨ Build Release AAB
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "ðŸ”¨ Construindo AAB de release..."
        ./gradlew bundleRelease
        
    - name: ðŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-${{ github.run_id }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ðŸ“¤ Upload Release AAB
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: release-aab-${{ github.run_id }}
        path: app/build/outputs/bundle/release/app-release.aab
        retention-days: 90

  # Job 3: Deploy para Staging
  deploy-staging:
    name: ðŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [automated-tests, build-app]
    if: success() && (github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging'))
    
    steps:
    - name: ðŸ“¥ Download Debug APK
      uses: actions/download-artifact@v4
      with:
        name: debug-apk-${{ github.run_id }}
        path: ./artifacts
        
    - name: ðŸ“± Deploy to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        groups: testers
        file: ./artifacts/app-debug.apk
        releaseNotes: |
          ðŸš€ Deploy Staging - Build #${{ github.run_number }}
          
          ðŸ“‹ MudanÃ§as:
          - Testes automatizados: âœ…
          - Build: âœ…
          - Deploy: âœ…
          
          ðŸ”— Commit: ${{ github.sha }}
          ðŸ‘¤ Autor: ${{ github.actor }}
          
    - name: ðŸ“§ Notify Staging Deploy
      run: |
        echo "ðŸš€ Deploy para staging concluÃ­do!"
        echo "ðŸ“± APK disponÃ­vel no Firebase App Distribution"
        echo "ðŸ”— Build: #${{ github.run_number }}"
        echo "ðŸ“‹ Commit: ${{ github.sha }}"

  # Job 4: Deploy para Production
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: [automated-tests, build-app]
    if: success() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production'))
    
    steps:
    - name: ðŸ“¥ Download Release AAB
      uses: actions/download-artifact@v4
      with:
        name: release-aab-${{ github.run_id }}
        path: ./artifacts
        
    - name: ðŸ” Setup Keystore
      env:
        ENCODED_KEYSTORE: ${{ secrets.ENCODED_KEYSTORE }}
      run: |
        echo "ðŸ” Configurando keystore..."
        echo $ENCODED_KEYSTORE | base64 -d > keystore.jks
        
    - name: ðŸ”¨ Build Signed Release AAB
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        echo "ðŸ”¨ Construindo AAB assinado..."
        ./gradlew bundleRelease \
          -Pandroid.injected.signing.store.file=../keystore.jks \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD
          
    - name: ðŸ“¤ Upload Signed AAB
      uses: actions/upload-artifact@v4
      with:
        name: signed-release-aab-${{ github.run_id }}
        path: app/build/outputs/bundle/release/app-release.aab
        retention-days: 365
        
    - name: ðŸ“¤ Upload Mapping File
      uses: actions/upload-artifact@v4
      with:
        name: mapping-file-${{ github.run_id }}
        path: app/build/outputs/mapping/release/mapping.txt
        retention-days: 365
        
    - name: ðŸ“± Deploy to Google Play Store
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}
        packageName: com.eyedock.app
        releaseFiles: app/build/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        
    - name: ðŸ“§ Notify Production Deploy
      run: |
        echo "ðŸš€ Deploy para produÃ§Ã£o concluÃ­do!"
        echo "ðŸ“± AAB enviado para Google Play Store"
        echo "ðŸ”— Build: #${{ github.run_number }}"
        echo "ðŸ“‹ Commit: ${{ github.sha }}"
        echo "ðŸ·ï¸ Tag: ${{ github.ref_name }}"

  # Job 5: NotificaÃ§Ãµes
  notifications:
    name: ðŸ“§ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [automated-tests, build-app, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“§ Notify Success
      if: success()
      run: |
        echo "ðŸŽ‰ Pipeline executado com sucesso!"
        echo "âœ… Testes: ${{ needs.automated-tests.result }}"
        echo "âœ… Build: ${{ needs.build-app.result }}"
        echo "âœ… Staging: ${{ needs.deploy-staging.result }}"
        echo "âœ… Production: ${{ needs.deploy-production.result }}"
        
    - name: ðŸ“§ Notify Failure
      if: failure()
      run: |
        echo "âŒ Pipeline falhou!"
        echo "âŒ Testes: ${{ needs.automated-tests.result }}"
        echo "âŒ Build: ${{ needs.build-app.result }}"
        echo "âŒ Staging: ${{ needs.deploy-staging.result }}"
        echo "âŒ Production: ${{ needs.deploy-production.result }}"
        
    - name: ðŸ“Š Generate Deployment Report
      run: |
        echo "ðŸ“Š RelatÃ³rio de Deploy" > deploy-report.md
        echo "=====================" >> deploy-report.md
        echo "" >> deploy-report.md
        echo "ðŸ”— Build: #${{ github.run_number }}" >> deploy-report.md
        echo "ðŸ“‹ Commit: ${{ github.sha }}" >> deploy-report.md
        echo "ðŸ‘¤ Autor: ${{ github.actor }}" >> deploy-report.md
        echo "ðŸ·ï¸ Branch: ${{ github.ref_name }}" >> deploy-report.md
        echo "" >> deploy-report.md
        echo "ðŸ“ˆ Status dos Jobs:" >> deploy-report.md
        echo "- Testes: ${{ needs.automated-tests.result }}" >> deploy-report.md
        echo "- Build: ${{ needs.build-app.result }}" >> deploy-report.md
        echo "- Staging: ${{ needs.deploy-staging.result }}" >> deploy-report.md
        echo "- Production: ${{ needs.deploy-production.result }}" >> deploy-report.md
        
    - name: ðŸ“¤ Upload Deployment Report
      uses: actions/upload-artifact@v4
      with:
        name: deploy-report-${{ github.run_id }}
        path: deploy-report.md
        retention-days: 30
